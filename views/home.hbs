<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Добро пожаловать в Ваш Банк</title>
    <link rel="stylesheet" href="/styles/homeStyle.css">
</head>
<body>
    <section class="greeting">
        <h2>Ваши средства</h2>

        <!-- Выпадающий список для выбора аккаунта -->
        <label for="accountSelect">Выберите аккаунт:</label>
        <select id="accountSelect" onchange="changeAccount(this.value)">
            {{#each accounts}}
                <option value="{{this._id}}" {{#if (eq this._id ../selectedAccountId)}}selected{{/if}}>{{this.accountNumber}} - {{this.balance}} ₽</option>
            {{/each}}
        </select>

        <p>Баланс текущего счета: <span class="balance-display">{{selectedAccount.balance}}</span></p>

        {{#if accounts.[0].savingsBalance}}
            <p>Баланс сберегательного счета: {{accounts.[0].savingsBalance}} ₽</p>
        {{/if}}

        {{#if upcomingPayments.length}}
            <div class="notifications">
                <h3>Ближайшие платежи по кредитам:</h3>
                <ul>
                    {{#each upcomingPayments}}
                        <li>
                            {{formatDate this.date}}: {{this.amount}} {{this.currency}} 
                            ({{this.loanId}})
                        </li>
                    {{/each}}
                </ul>
            </div>
        {{/if}}
    </section>

    <section class="bank-services">
        <h2>Возможности нашего банка</h2>
        <ul>
            <li><strong>Переводы:</strong> Быстрые и безопасные переводы между счетами.</li>
            <li><strong>Сберегательный счёт:</strong> Удобное хранение средств на сберегательном счёте.</li>
            <li><strong>Кредиты:</strong> Конкурентные ставки на кредиты.</li>
        </ul>
    </section>

    <section class="quick-actions">
        <h2>Быстрые действия</h2>
        <button onclick="location.href='/main/deposit'">Пополнить счет</button>
        <button onclick="location.href='/main/transfer'">Перевести средства на другой счёт</button>
        <button onclick="location.href='/main/saving-account/create'">Создать сберегательный счет</button>
        <button onclick="location.href='/main/loans/new'">Оформить кредит</button>
    </section>

    <section class="recent-transactions">
        <h2>Транзакции</h2>

        <button onclick="location.href='/main/transactions'">Посмотреть историю транзакций</button>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const selectedAccountId = document.getElementById('accountSelect').value;
            await updateBalance(selectedAccountId);
        });

        async function changeAccount(accountId) {
            await updateBalance(accountId);
            
            try {
                const response = await fetch(`/main/change-account/${accountId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include' // Важно для сессий
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Ошибка сервера');
                }

                const data = await response.json();
                
                // Обновляем баланс на странице без перезагрузки
                const balanceElement = document.querySelector('.balance-display');
                if (balanceElement && data.account) {
                    balanceElement.textContent = `${data.account.balance} ₽`;
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert(error.message || 'Ошибка соединения с сервером');
            }
        }

        async function updateBalance(accountId) {
            try {
                const response = await fetch(`/main/account-balance/${accountId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Не удалось получить данные о счете');
                }

                const data = await response.json();
                
                // Обновляем баланс на странице
                const balanceElement = document.querySelector('.balance-display');
                if (balanceElement && data.balance !== undefined) {
                    balanceElement.textContent = `${data.balance} ₽`;
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }
    </script>
</body>
</html>